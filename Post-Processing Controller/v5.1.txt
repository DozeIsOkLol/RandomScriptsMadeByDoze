-- =================================================================================================
--  UILIB | Ultimate Post-Processing Suite v5.1 (Stable Sequencer & New Presets)
-- =================================================================================================

-- Step 1: Load the Library and Services
local UILIB = loadstring(game:HttpGet('https://raw.githubusercontent.com/DozeIsOkLol/LibWare/refs/heads/main/testing/Library/Source.lua'))()
local TweenService = game:GetService('TweenService')
local Lighting = game:GetService('Lighting')
local Terrain = workspace:FindFirstChildOfClass('Terrain')

-- Step 2: Create the Main Window
local Window = UILIB:CreateWindow({
    Title = 'Environmental Suite',
    Version = 'v5.1',
})

-- Step 3: Create Tabs
local MainTab = Window:CreateTab('Main Settings')
local EffectsTab = Window:CreateTab('Effects')
local AtmosphereTab = Window:CreateTab('Atmosphere')
local WorldTab = Window:CreateTab('World')
local ShadersTab = Window:CreateTab('Presets')
local AmbiencesTab = Window:CreateTab('Ambiences')
local SequencerTab = Window:CreateTab('Sequencer')

----------------------------------------------------
-- Effect Management (Ensures they exist)
----------------------------------------------------
local colorCorrection = Lighting:FindFirstChildOfClass('ColorCorrectionEffect') or Instance.new('ColorCorrectionEffect', Lighting)
local bloom = Lighting:FindFirstChildOfClass('BloomEffect') or Instance.new('BloomEffect', Lighting)
local sunRays = Lighting:FindFirstChildOfClass('SunRaysEffect') or Instance.new('SunRaysEffect', Lighting)
local blur = Lighting:FindFirstChildOfClass('BlurEffect') or Instance.new('BlurEffect', Lighting)
local depthOfField = Lighting:FindFirstChildOfClass('DepthOfFieldEffect') or Instance.new('DepthOfFieldEffect', Lighting)
local atmosphere = Lighting:FindFirstChildOfClass('Atmosphere') or Instance.new('Atmosphere', Lighting)
local sky = Lighting:FindFirstChildOfClass('Sky') or Instance.new('Sky', Lighting)
local ambienceStates = { dayNightCycle = false, thunderstorm = false, pulsing = false, flickering = false, rain = false }

----------------------------------------------------
-- Core Logic for Presets, Resets, and Keyframes
----------------------------------------------------
local tweenInfo = TweenInfo.new(1.0, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)

local function getCurrentSettings()
    return {
        Brightness = Lighting.Brightness, ClockTime = Lighting.ClockTime, FogStart = Lighting.FogStart, FogEnd = Lighting.FogEnd, FogColor = Lighting.FogColor,
        Contrast = colorCorrection.Contrast, Saturation = colorCorrection.Saturation, TintColor = colorCorrection.TintColor,
        BloomIntensity = bloom.Intensity, SunRaysIntensity = sunRays.Intensity, BlurSize = blur.Size,
        DofEnabled = depthOfField.Enabled, DofFocus = depthOfField.FocusDistance, DofFar = depthOfField.FarIntensity, DofNear = depthOfField.NearIntensity,
        AtmosHaze = atmosphere.Haze, AtmosDensity = atmosphere.Density,
        WaterWaveSize = Terrain.WaterWaveSize, WaterWaveSpeed = Terrain.WaterWaveSpeed, WaterTransparency = Terrain.WaterTransparency, WaterColor = Terrain.WaterColor,
        GrassColor = Terrain:GetMaterialColor("Grass"), SandColor = Terrain:GetMaterialColor("Sand"), RockColor = Terrain:GetMaterialColor("Rock")
    }
end

local function ApplyState(settings, tweenDuration)
    local info = tweenDuration and TweenInfo.new(tweenDuration, Enum.EasingStyle.Linear) or tweenInfo
    local useTween = tweenDuration ~= nil

    local function apply(inst, prop, val)
        if useTween then TweenService:Create(inst, info, {[prop] = val}):Play() else inst[prop] = val end
    end
    
    apply(Lighting, "Brightness", settings.Brightness); apply(Lighting, "ClockTime", settings.ClockTime)
    apply(Lighting, "FogStart", settings.FogStart); apply(Lighting, "FogEnd", settings.FogEnd); apply(Lighting, "FogColor", settings.FogColor)
    apply(colorCorrection, "Contrast", settings.Contrast); apply(colorCorrection, "Saturation", settings.Saturation); apply(colorCorrection, "TintColor", settings.TintColor)
    apply(bloom, "Intensity", settings.BloomIntensity); apply(sunRays, "Intensity", settings.SunRaysIntensity); apply(blur, "Size", settings.BlurSize)
    depthOfField.Enabled = settings.DofEnabled
    apply(depthOfField, "FocusDistance", settings.DofFocus); apply(depthOfField, "FarIntensity", settings.DofFar); apply(depthOfField, "NearIntensity", settings.DofNear)
    apply(atmosphere, "Haze", settings.AtmosHaze); apply(atmosphere, "Density", settings.AtmosDensity)
    apply(Terrain, "WaterWaveSize", settings.WaterWaveSize); apply(Terrain, "WaterWaveSpeed", settings.WaterWaveSpeed); apply(Terrain, "WaterTransparency", settings.WaterTransparency); apply(Terrain, "WaterColor", settings.WaterColor)
    
    local function applyMaterialColors()
        Terrain:SetMaterialColor("Grass", settings.GrassColor); Terrain:SetMaterialColor("Sand", settings.SandColor); Terrain:SetMaterialColor("Rock", settings.RockColor)
    end
    if useTween then task.delay(tweenDuration, applyMaterialColors) else applyMaterialColors() end
end

----------------------------------------------------
-- Main Tab (Core Settings & Reset)
----------------------------------------------------
MainTab:AddLabel('Core Lighting Properties')
MainTab:AddSlider({Name = 'Brightness', Min = 0, Max = 4, Default = Lighting.Brightness, Callback = function(v) Lighting.Brightness = v end})
MainTab:AddSlider({Name = 'Contrast', Min = -1, Max = 1, Default = colorCorrection.Contrast, Callback = function(v) colorCorrection.Contrast = v end})
MainTab:AddSlider({Name = 'Saturation', Min = -1, Max = 1, Default = colorCorrection.Saturation, Callback = function(v) colorCorrection.Saturation = v end})
MainTab:AddParagraph('')
MainTab:AddButton({
    Name = 'Reset All to Default',
    Callback = function()
        ApplyState({
            Brightness = 2, Contrast = 0, Saturation = 0, TintColor = Color3.new(1, 1, 1), ClockTime = 14,
            BloomIntensity = 0.5, SunRaysIntensity = 0.1, BlurSize = 0, DofEnabled = false, DofFocus = 100, DofFar = 0.1, DofNear = 0,
            AtmosHaze = 0, AtmosDensity = 0.35, FogStart = 0, FogEnd = 100000, FogColor = Color3.new(0.75, 0.75, 0.75),
            WaterWaveSize = 8, WaterWaveSpeed = 10, WaterTransparency = 0.5, WaterColor = Color3.fromRGB(0, 162, 255),
            GrassColor = Color3.fromRGB(110, 150, 70), SandColor = Color3.fromRGB(190, 170, 130), RockColor = Color3.fromRGB(130, 130, 130)
        }, nil)
        UILIB:Notify({Title = 'System', Text = 'All settings have been reset.', Duration = 4})
    end,
})

----------------------------------------------------
-- Effects, Atmosphere, World Tabs (No changes, complete code included)
----------------------------------------------------
EffectsTab:AddLabel('Bloom & Sun Rays'); EffectsTab:AddSlider({Name = 'Bloom Intensity', Min = 0, Max = 2, Default = bloom.Intensity, Callback = function(v) bloom.Intensity = v end})
EffectsTab:AddSlider({Name = 'Sun Rays Intensity', Min = 0, Max = 1, Default = sunRays.Intensity, Callback = function(v) sunRays.Intensity = v end})
EffectsTab:AddLabel('Blur'); EffectsTab:AddSlider({Name = 'Blur Size', Min = 0, Max = 24, Default = blur.Size, Callback = function(v) blur.Size = v end})
EffectsTab:AddLabel('Depth of Field'); EffectsTab:AddToggle({Name = 'Enable Depth of Field', Default = depthOfField.Enabled, Callback = function(v) depthOfField.Enabled = v end})
EffectsTab:AddSlider({Name = 'Focus Distance', Min = 1, Max = 1000, Default = depthOfField.FocusDistance, Callback = function(v) depthOfField.FocusDistance = v end})
EffectsTab:AddSlider({Name = 'Far Intensity', Min = 0, Max = 1, Default = depthOfField.FarIntensity, Callback = function(v) depthOfField.FarIntensity = v end})
EffectsTab:AddSlider({Name = 'Near Intensity', Min = 0, Max = 1, Default = depthOfField.NearIntensity, Callback = function(v) depthOfField.NearIntensity = v end})

AtmosphereTab:AddLabel('Time & Sky'); AtmosphereTab:AddSlider({Name = 'Time of Day', Min = 0, Max = 24, Default = Lighting.ClockTime, Callback = function(v) Lighting.ClockTime = v end})
local skyboxIdInput = ""; AtmosphereTab:AddTextbox({Name = "Skybox ID", Placeholder = "rbxassetid://...", Callback = function(t) skyboxIdInput = t end})
AtmosphereTab:AddButton({Name = "Load Skybox", Callback = function() if skyboxIdInput:match("%d+") then local id = "rbxassetid://" .. skyboxIdInput:match("%d+"); sky.SkyboxFt, sky.SkyboxBk, sky.SkyboxUp, sky.SkyboxDn, sky.SkyboxLf, sky.SkyboxRt = id,id,id,id,id,id; UILIB:Notify({Title = "Skybox Loaded"}) else UILIB:Notify({Title = "Invalid Skybox ID"}) end end})
AtmosphereTab:AddLabel('Atmosphere & Fog'); AtmosphereTab:AddSlider({Name = 'Atmosphere Haze', Min = 0, Max = 5, Default = atmosphere.Haze, Callback = function(v) atmosphere.Haze = v end})
AtmosphereTab:AddSlider({Name = 'Atmosphere Density', Min = 0, Max = 1, Default = atmosphere.Density, Callback = function(v) atmosphere.Density = v end})
AtmosphereTab:AddSlider({Name = 'Fog Start', Min = 0, Max = 1000, Default = Lighting.FogStart, Callback = function(v) Lighting.FogStart = v end}); AtmosphereTab:AddSlider({Name = 'Fog End', Min = 0, Max = 100000, Default = Lighting.FogEnd, Callback = function(v) Lighting.FogEnd = v end})
local currentFogColor = {R = Lighting.FogColor.R * 255, G = Lighting.FogColor.G * 255, B = Lighting.FogColor.B * 255}; local function updateFogColor() Lighting.FogColor = Color3.new(currentFogColor.R/255, currentFogColor.G/255, currentFogColor.B/255) end
AtmosphereTab:AddSlider({Name = 'Fog Red', Min = 0, Max = 255, Default = currentFogColor.R, Callback = function(v) currentFogColor.R=v; updateFogColor() end}); AtmosphereTab:AddSlider({Name = 'Fog Green', Min = 0, Max = 255, Default = currentFogColor.G, Callback = function(v) currentFogColor.G=v; updateFogColor() end}); AtmosphereTab:AddSlider({Name = 'Fog Blue', Min = 0, Max = 255, Default = currentFogColor.B, Callback = function(v) currentFogColor.B=v; updateFogColor() end})
AtmosphereTab:AddLabel('Color Correction Tint'); local currentTintColor = {R = colorCorrection.TintColor.R * 255, G = colorCorrection.TintColor.G * 255, B = colorCorrection.TintColor.B * 255}; local function updateTintColor() colorCorrection.TintColor = Color3.new(currentTintColor.R / 255, currentTintColor.G / 255, currentTintColor.B / 255) end
AtmosphereTab:AddSlider({Name = 'Tint Red', Min = 0, Max = 255, Default = currentTintColor.R, Callback = function(v) currentTintColor.R = v; updateTintColor() end}); AtmosphereTab:AddSlider({Name = 'Tint Green', Min = 0, Max = 255, Default = currentTintColor.G, Callback = function(v) currentTintColor.G = v; updateTintColor() end}); AtmosphereTab:AddSlider({Name = 'Tint Blue', Min = 0, Max = 255, Default = currentTintColor.B, Callback = function(v) currentTintColor.B = v; updateTintColor() end})

WorldTab:AddLabel("Water Properties"); WorldTab:AddSlider({Name = 'Water Wave Size', Min = 0, Max = 100, Default = Terrain.WaterWaveSize, Callback = function(v) Terrain.WaterWaveSize = v end})
WorldTab:AddSlider({Name = 'Water Wave Speed', Min = 0, Max = 100, Default = Terrain.WaterWaveSpeed, Callback = function(v) Terrain.WaterWaveSpeed = v end}); WorldTab:AddSlider({Name = 'Water Transparency', Min = 0, Max = 1, Default = Terrain.WaterTransparency, Callback = function(v) Terrain.WaterTransparency = v end})
local currentWaterColor = {R = Terrain.WaterColor.R * 255, G = Terrain.WaterColor.G * 255, B = Terrain.WaterColor.B * 255}; local function updateWaterColor() Terrain.WaterColor = Color3.new(currentWaterColor.R/255, currentWaterColor.G/255, currentWaterColor.B/255) end
WorldTab:AddSlider({Name = 'Water Red', Min = 0, Max = 255, Default = currentWaterColor.R, Callback = function(v) currentWaterColor.R=v; updateWaterColor() end}); WorldTab:AddSlider({Name = 'Water Green', Min = 0, Max = 255, Default = currentWaterColor.G, Callback = function(v) currentWaterColor.G=v; updateWaterColor() end}); WorldTab:AddSlider({Name = 'Water Blue', Min = 0, Max = 255, Default = currentWaterColor.B, Callback = function(v) currentWaterColor.B=v; updateWaterColor() end})
WorldTab:AddLabel("Terrain Material Colors"); local grass = Terrain:GetMaterialColor("Grass"); local currentGrassColor = {R=grass.R*255,G=grass.G*255,B=grass.B*255}; local function updateGrassColor() Terrain:SetMaterialColor("Grass", Color3.fromRGB(currentGrassColor.R, currentGrassColor.G, currentGrassColor.B)) end
WorldTab:AddSlider({Name = 'Grass Red', Min = 0, Max = 255, Default = currentGrassColor.R, Callback = function(v) currentGrassColor.R=v; updateGrassColor() end}); WorldTab:AddSlider({Name = 'Grass Green', Min = 0, Max = 255, Default = currentGrassColor.G, Callback = function(v) currentGrassColor.G=v; updateGrassColor() end}); WorldTab:AddSlider({Name = 'Grass Blue', Min = 0, Max = 255, Default = currentGrassColor.B, Callback = function(v) currentGrassColor.B=v; updateGrassColor() end})
local sand = Terrain:GetMaterialColor("Sand"); local currentSandColor = {R=sand.R*255,G=sand.G*255,B=sand.B*255}; local function updateSandColor() Terrain:SetMaterialColor("Sand", Color3.fromRGB(currentSandColor.R, currentSandColor.G, currentSandColor.B)) end
WorldTab:AddSlider({Name = 'Sand Red', Min = 0, Max = 255, Default = currentSandColor.R, Callback = function(v) currentSandColor.R=v; updateSandColor() end}); WorldTab:AddSlider({Name = 'Sand Green', Min = 0, Max = 255, Default = currentSandColor.G, Callback = function(v) currentSandColor.G=v; updateSandColor() end}); WorldTab:AddSlider({Name = 'Sand Blue', Min = 0, Max = 255, Default = currentSandColor.B, Callback = function(v) currentSandColor.B=v; updateSandColor() end})
local rock = Terrain:GetMaterialColor("Rock"); local currentRockColor = {R=rock.R*255,G=rock.G*255,B=rock.B*255}; local function updateRockColor() Terrain:SetMaterialColor("Rock", Color3.fromRGB(currentRockColor.R, currentRockColor.G, currentRockColor.B)) end
WorldTab:AddSlider({Name = 'Rock Red', Min = 0, Max = 255, Default = currentRockColor.R, Callback = function(v) currentRockColor.R=v; updateRockColor() end}); WorldTab:AddSlider({Name = 'Rock Green', Min = 0, Max = 255, Default = currentRockColor.G, Callback = function(v) currentRockColor.G=v; updateRockColor() end}); WorldTab:AddSlider({Name = 'Rock Blue', Min = 0, Max = 255, Default = currentRockColor.B, Callback = function(v) currentRockColor.B=v; updateRockColor() end})

----------------------------------------------------
-- Shaders Tab (Presets)
----------------------------------------------------
local presets = {
    Glossy = {Brightness=1.2, Contrast=0.2, Saturation=0.3, BloomIntensity=1.5, SunRaysIntensity=0.25},
    Vintage = {Brightness=0.9, Contrast=-0.1, Saturation=-0.5, BloomIntensity=0.2, SunRaysIntensity=0.1, TintColor=Color3.fromRGB(255, 230, 200)},
    Neon = {Brightness=1.5, Contrast=0.4, Saturation=0.6, BloomIntensity=2.0, SunRaysIntensity=0.5, ClockTime = 2},
    Horror = {Brightness=0.6, Contrast=0.5, Saturation=-0.8, BloomIntensity=0.5, SunRaysIntensity=0.05, TintColor=Color3.fromRGB(180, 200, 255), BlurSize=2, ClockTime = 23, FogEnd = 500, FogColor = Color3.new(0,0,0)},
    Cinematic = {Brightness=1.0, Contrast=0.15, Saturation=-0.2, BloomIntensity=0.6, SunRaysIntensity=0.1, DofEnabled=true, DofFocus=25, DofFar=0.2, ClockTime = 16},
    Desert = {Brightness=1.4, Contrast=0.1, Saturation=0.2, BloomIntensity=0.4, SunRaysIntensity=0.8, TintColor=Color3.fromRGB(255, 220, 180), ClockTime = 15, FogEnd = 5000, WaterColor = Color3.fromRGB(130, 160, 140), SandColor = Color3.fromRGB(220, 200, 160)},
    EnchantedForest = {Brightness=1.1, Contrast=0.1, Saturation=0.4, BloomIntensity=0.8, SunRaysIntensity=0.6, TintColor=Color3.fromRGB(230, 255, 220), AtmosHaze = 0.5, FogEnd = 3000, GrassColor = Color3.fromRGB(80, 180, 90), WaterColor = Color3.fromRGB(100, 220, 200)},
    SynthwaveCity = {Brightness=1.3, Contrast=0.3, Saturation=0.5, BloomIntensity=1.8, TintColor=Color3.fromRGB(200, 180, 255), ClockTime = 22, AtmosDensity = 0.6, FogEnd = 4000, FogColor = Color3.fromRGB(20, 10, 30), WaterColor = Color3.fromRGB(50, 20, 80)},
    Wasteland = {Brightness=1.6, Contrast=0.25, Saturation=-0.6, TintColor=Color3.fromRGB(255, 210, 170), ClockTime = 13, AtmosDensity=0.1, AtmosHaze=0.2, FogColor = Color3.fromRGB(180,160,140), FogEnd = 6000, WaterColor=Color3.fromRGB(140,120,90), GrassColor=Color3.fromRGB(140,110,70)}
}
ShadersTab:AddLabel('Built-in Environmental Presets'); for name, settings in pairs(presets) do ShadersTab:AddButton({Name = name, Callback = function() local fullSettings = getCurrentSettings(); for k,v in pairs(settings) do fullSettings[k] = v end; ApplyState(fullSettings) end}) end

----------------------------------------------------
-- Ambiences Tab
----------------------------------------------------
AmbiencesTab:AddLabel('Dynamic & Weather Effects'); AmbiencesTab:AddToggle({Name = 'Day/Night Cycle', Callback = function(v) ambienceStates.dayNightCycle = v; if v then task.spawn(function() while ambienceStates.dayNightCycle do Lighting.ClockTime = (Lighting.ClockTime + 0.01) % 24; task.wait() end end) end end})
local rainEmitter = nil; AmbiencesTab:AddToggle({Name = 'Weather: Rain', Callback = function(v) ambienceStates.rain = v; local beforeState; if v then beforeState = getCurrentSettings(); ApplyState({Brightness = 0.7, FogEnd = 2000, AtmosHaze = 1.5}); rainEmitter = Instance.new("ParticleEmitter", workspace.CurrentCamera); rainEmitter.Texture = "rbxassetid://174542337"; rainEmitter.Size = NumberSequence.new(0.1, 0.2); rainEmitter.Lifetime = NumberRange.new(1); rainEmitter.Rate = 500; rainEmitter.Speed = NumberRange.new(50); rainEmitter.SpreadAngle = Vector2.new(15, 15); rainEmitter.Acceleration = Vector3.new(0, -20, 0); rainEmitter.EmissionDirection = Enum.NormalId.Top else ApplyState(beforeState); if rainEmitter then rainEmitter:Destroy() end end end})

----------------------------------------------------
-- Sequencer Tab (FIXED)
----------------------------------------------------
local keyframes = {}; local sequenceDuration = 10
SequencerTab:AddLabel("Scene Sequencer"); SequencerTab:AddParagraph("Create cinematic environmental shifts. Save multiple states (keyframes) and play them as a smooth sequence.")
SequencerTab:AddButton({Name = "Save Current as Keyframe", Callback = function() table.insert(keyframes, getCurrentSettings()); UILIB:Notify({Title = "Keyframe " .. #keyframes .. " Saved"}) end})
SequencerTab:AddSlider({Name = "Sequence Duration (s)", Min = 1, Max = 120, Default = 10, Callback = function(v) sequenceDuration = v end})
SequencerTab:AddButton({Name = "Play Sequence", Callback = function() if #keyframes < 2 then UILIB:Notify({Title = "Error", Text = "Need at least 2 keyframes."}); return end; UILIB:Notify({Title = "Sequencer", Text = "Playing sequence..."}); task.spawn(function() local transitionTime = sequenceDuration / (#keyframes - 1); for i=1, #keyframes - 1 do ApplyState(keyframes[i+1], transitionTime); task.wait(transitionTime) end; UILIB:Notify({Title = "Sequencer", Text = "Sequence finished."}) end) end})
SequencerTab:AddButton({Name = "Clear All Keyframes", Callback = function() keyframes = {}; UILIB:Notify({Title = "Sequencer", Text = "All keyframes cleared."}) end})

-- Final welcome notification
task.wait(1); UILIB:Notify({Title = 'Environmental Suite Loaded', Text = 'All systems ready.', Duration = 5})